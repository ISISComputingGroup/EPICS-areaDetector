TOP=../..

include $(TOP)/configure/CONFIG

# -------------------------------
# Build an Diamond Support Module
# -------------------------------

# This tells the compiler to ignore errors generated by EPICS includes.  We need
# this because the EPICS headers have non strict prototypes in places.
USR_CPPFLAGS_Linux += -isystem $(EPICS_BASE)/include

# Nice and strict...
USR_CXXFLAGS_Linux += -Werror
USR_CXXFLAGS_Linux += -Wall -Wextra
USR_CXXFLAGS_Linux += -Wno-unused-parameter
USR_CXXFLAGS_Linux += -Wno-missing-field-initializers
USR_CXXFLAGS_Linux += -Wundef
USR_CXXFLAGS_Linux += -Wshadow
USR_CXXFLAGS_Linux += -Wcast-align
USR_CXXFLAGS_Linux += -Wwrite-strings
USR_CXXFLAGS_Linux += -Wredundant-decls
USR_CXXFLAGS_Linux += -Wmissing-declarations

LIBRARY_IOC += adPython

# xxxRecord.dbd will be installed into <top>/dbd
DBD += adPythonPlugin.dbd

# The following are compiled and added to the support library
adPython_SRCS += adPythonPlugin.cpp

# Guess the python executable
ifneq ($(PYTHON_PREFIX),)
    PYTHON = $(PYTHON_PREFIX)/bin/python
else
    PYTHON = python
endif
PYTHON = python
# Get the version string of python
PYTHON_VERSION = $(shell $(PYTHON) -c 'from distutils import sysconfig; \
    print sysconfig.get_config_var("VERSION")')

USR_INCLUDES_WIN32 += -Ic:/Instrument/Apps/Python/include
USR_LDFLAGS_WIN32 += /libpath:c:/Instrument/Apps/Python/libs
# link against python
ifneq ($(PYTHON_PREFIX),)
    # user defined prefix, add it explicitly
	USR_INCLUDES += -I$(PYTHON_PREFIX)/include/python$(PYTHON_VERSION)
ifeq ($(OS_CLASS),WIN32)
	python$(PYTHON_VERSION)_DIR = c:/Instrument/Apps/Python/libs
else
	python$(PYTHON_VERSION)_DIR = $(PYTHON_PREFIX)/lib64
endif
	adPython_LIBS += python$(PYTHON_VERSION)
	# add the numpy include path too, which is printed out when we run
	# adPythonPlugin.py from the command line
	USR_INCLUDES += -I$(shell $(PYTHON) ../adPythonPlugin.py)
else
    # it's in a standard place
	adPython_SYS_LIBS += python$(PYTHON_VERSION)
endif

USR_CXXFLAGS += -DDATADIRS=\"$(shell cd ..; pwd):$(shell cd ../../scripts; pwd)\"

adPython_LIBS += NDPlugin

include $(ADCORE)/ADApp/commonLibraryMakefile

include $(TOP)/configure/RULES
