<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>adPython: /dls_sw/prod/R3.14.12.3/support/adPython/0-2/adPythonApp/src/adPythonPlugin.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_8663d678f308f18bc0e6800fd9a1b571.html">adPythonApp</a>      </li>
      <li><a class="el" href="dir_b196b44712ae49350936224f6f56bb6f.html">src</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>adPythonPlugin.cpp</h1>  </div>
</div>
<div class="contents">
<a href="adPythonPlugin_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Nasty nasty hack so that Python.h is happy. */</span>
<a name="l00002"></a>00002 <span class="preprocessor">#undef _POSIX_C_SOURCE</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor">#undef _XOPEN_SOURCE</span>
<a name="l00004"></a><a class="code" href="adPythonPlugin_8cpp.html#a3024ccd4a9af5109d24e6c57565d74a1">00004</a> <span class="preprocessor"></span><span class="preprocessor">#define _POSIX_C_SOURCE 200112L</span>
<a name="l00005"></a><a class="code" href="adPythonPlugin_8cpp.html#a78c99ffd76a7bb3c8c74db76207e9ab4">00005</a> <span class="preprocessor"></span><span class="preprocessor">#define _XOPEN_SOURCE 600</span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor">#include &lt;Python.h&gt;</span>
<a name="l00007"></a><a class="code" href="adPythonPlugin_8cpp.html#abeb9a87b1dc6b0a1a9d82454f530c1da">00007</a> <span class="preprocessor">#define PYTHON_USE_NUMPY</span>
<a name="l00008"></a><a class="code" href="adPythonPlugin_8cpp.html#ab6e6ee86736f9ebb56e74ae21bf3ff8a">00008</a> <span class="preprocessor"></span><span class="preprocessor">#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor">#include &quot;numpy/ndarrayobject.h&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;libgen.h&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;epicsTime.h&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;NDArray.h&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="adPythonPlugin_8h.html">adPythonPlugin.h</a>&quot;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="comment">// User plugin and adPythonPlugin.py working</span>
<a name="l00017"></a><a class="code" href="adPythonPlugin_8cpp.html#a4adf7c6105c54a1608753548236d1387">00017</a> <span class="preprocessor">#define GOOD 0</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span><span class="comment">// User plugin not working</span>
<a name="l00019"></a><a class="code" href="adPythonPlugin_8cpp.html#afd3fc9004925132db4faf607ebbf9db7">00019</a> <span class="preprocessor">#define BAD 1</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span><span class="comment">// adPythonPlugin.py not working</span>
<a name="l00021"></a><a class="code" href="adPythonPlugin_8cpp.html#aa48769014166b468765be8d748b8ecf0">00021</a> <span class="preprocessor">#define UGLY 2</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 <span class="comment">// Some macros to set an error state and print a message</span>
<a name="l00024"></a><a class="code" href="adPythonPlugin_8cpp.html#a8fc08549dfa4c9972afded3c2728bfdd">00024</a> <span class="preprocessor">#define NoGood(errString, st) {                         \</span>
<a name="l00025"></a>00025 <span class="preprocessor">    asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,    \</span>
<a name="l00026"></a>00026 <span class="preprocessor">        &quot;%s:%s: &quot; errString &quot;\n&quot;,                       \</span>
<a name="l00027"></a>00027 <span class="preprocessor">        driverName, __func__);                          \</span>
<a name="l00028"></a>00028 <span class="preprocessor">    this-&gt;pluginState = st;                             \</span>
<a name="l00029"></a>00029 <span class="preprocessor">    setIntegerParam(adPythonState, this-&gt;pluginState);  \</span>
<a name="l00030"></a>00030 <span class="preprocessor">    callParamCallbacks();                               \</span>
<a name="l00031"></a>00031 <span class="preprocessor">    PyErr_Clear();                                      \</span>
<a name="l00032"></a>00032 <span class="preprocessor">    return asynError;                                   \</span>
<a name="l00033"></a>00033 <span class="preprocessor">}</span>
<a name="l00034"></a><a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define Bad(errString) NoGood(errString, BAD)</span>
<a name="l00035"></a><a class="code" href="adPythonPlugin_8cpp.html#adbde97e2eabf9b7ae8fd2224db37bb98">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define Ugly(errString) NoGood(errString, UGLY)</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a>00037 <span class="comment">// Used in error printing</span>
<a name="l00038"></a><a class="code" href="adPythonPlugin_8cpp.html#af0e94d13028051cd5339d204bfbb057d">00038</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adPythonPlugin_8cpp.html#af0e94d13028051cd5339d204bfbb057d">driverName</a> = <span class="stringliteral">&quot;adPythonPlugin&quot;</span>;
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="comment">// This holds the threadState of the thread that initialised python</span>
<a name="l00041"></a>00041 <span class="comment">// We need it to get a handle on the interpreter so create a threadState</span>
<a name="l00042"></a>00042 <span class="comment">// object for each port</span>
<a name="l00043"></a>00043 <span class="keyword">static</span> PyThreadState *mainThreadState = NULL;
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="classadPythonPlugin.html#a081b0a9d5c4122b9667c72c526307083">00045</a> <a class="code" href="classadPythonPlugin.html#a081b0a9d5c4122b9667c72c526307083">adPythonPlugin::adPythonPlugin</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *portNameArg, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename,
<a name="l00046"></a>00046                    <span class="keyword">const</span> <span class="keywordtype">char</span> *classname, <span class="keywordtype">int</span> queueSize, <span class="keywordtype">int</span> blockingCallbacks,
<a name="l00047"></a>00047                    <span class="keyword">const</span> <span class="keywordtype">char</span> *NDArrayPort, <span class="keywordtype">int</span> NDArrayAddr, <span class="keywordtype">int</span> maxBuffers, 
<a name="l00048"></a>00048                    <span class="keywordtype">size_t</span> maxMemory, <span class="keywordtype">int</span> priority, <span class="keywordtype">int</span> stackSize)
<a name="l00049"></a>00049     : NDPluginDriver(portNameArg, queueSize, blockingCallbacks,
<a name="l00050"></a>00050                        NDArrayPort, NDArrayAddr, 1, <a class="code" href="adPythonPlugin_8h.html#aec502e4b2121875888055158f6258270">NUM_ADPYTHONPLUGIN_PARAMS</a>, 
<a name="l00051"></a>00051                        maxBuffers, maxMemory,
<a name="l00052"></a>00052                        asynGenericPointerMask|asynFloat64ArrayMask,
<a name="l00053"></a>00053                        asynGenericPointerMask|asynFloat64ArrayMask,
<a name="l00054"></a>00054                        ASYN_MULTIDEVICE, 1, priority, stackSize) 
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056     <span class="comment">// Initialise some params</span>
<a name="l00057"></a>00057     this-&gt;pInstance = NULL;
<a name="l00058"></a>00058     this-&gt;pParams = NULL;    
<a name="l00059"></a>00059     this-&gt;pProcessArray = NULL;
<a name="l00060"></a>00060     this-&gt;pParamChanged = NULL;
<a name="l00061"></a>00061     this-&gt;pMakePyInst = NULL;
<a name="l00062"></a>00062     this-&gt;pAttrs = NULL;
<a name="l00063"></a>00063     this-&gt;pProcessArgs = NULL;
<a name="l00064"></a>00064     this-&gt;nextParam = 0;
<a name="l00065"></a>00065     this-&gt;pluginState = 0;
<a name="l00066"></a>00066     this-&gt;pFileAttributes = <span class="keyword">new</span> NDAttributeList;
<a name="l00067"></a>00067    
<a name="l00068"></a>00068     <span class="comment">// Create the base class parameters (our python class may make some more)</span>
<a name="l00069"></a>00069     setStringParam(NDPluginDriverPluginType, <a class="code" href="adPythonPlugin_8cpp.html#af0e94d13028051cd5339d204bfbb057d">driverName</a>);
<a name="l00070"></a>00070     createParam(<span class="stringliteral">&quot;ADPYTHON_FILENAME&quot;</span>,   asynParamOctet,   &amp;<a class="code" href="classadPythonPlugin.html#ae43d79535fa567212732349928b11cf8">adPythonFilename</a>);
<a name="l00071"></a>00071     setStringParam(<a class="code" href="classadPythonPlugin.html#ae43d79535fa567212732349928b11cf8">adPythonFilename</a>,   filename);
<a name="l00072"></a>00072     createParam(<span class="stringliteral">&quot;ADPYTHON_CLASSNAME&quot;</span>,  asynParamOctet,   &amp;<a class="code" href="classadPythonPlugin.html#a90ce926293785741988457132e9b6da0">adPythonClassname</a>);
<a name="l00073"></a>00073     setStringParam(<a class="code" href="classadPythonPlugin.html#a90ce926293785741988457132e9b6da0">adPythonClassname</a>,  classname);
<a name="l00074"></a>00074     createParam(<span class="stringliteral">&quot;ADPYTHON_LOAD&quot;</span>,       asynParamInt32,   &amp;<a class="code" href="classadPythonPlugin.html#ac46d9e7f76ebfa2599fbc34e0393f69c">adPythonLoad</a>);
<a name="l00075"></a>00075     createParam(<span class="stringliteral">&quot;ADPYTHON_TIME&quot;</span>,       asynParamFloat64, &amp;<a class="code" href="classadPythonPlugin.html#a928016136ec8ce67d75c5fcd644579e0">adPythonTime</a>);    
<a name="l00076"></a>00076     createParam(<span class="stringliteral">&quot;ADPYTHON_STATE&quot;</span>,      asynParamInt32,   &amp;<a class="code" href="classadPythonPlugin.html#a96ed619adee5401e9078099ac51e1d0a">adPythonState</a>);        
<a name="l00077"></a>00077 
<a name="l00078"></a>00078     <span class="comment">// First we tell python where to find adPythonPlugin.py</span>
<a name="l00079"></a>00079     <span class="keywordtype">char</span> buffer[BIGBUFFER];
<a name="l00080"></a>00080     snprintf(buffer, <span class="keyword">sizeof</span>(buffer), <span class="stringliteral">&quot;PYTHONPATH=%s&quot;</span>, DATADIR);
<a name="l00081"></a>00081     putenv(buffer);
<a name="l00082"></a>00082     
<a name="l00083"></a>00083     <span class="comment">// Now we initialise python</span>
<a name="l00084"></a>00084     <span class="keywordflow">if</span> (!Py_IsInitialized()) {
<a name="l00085"></a>00085         PyEval_InitThreads();
<a name="l00086"></a>00086         Py_Initialize();
<a name="l00087"></a>00087     
<a name="l00088"></a>00088         <span class="comment">// Be sure to save thread state to release the GIL and give a handle</span>
<a name="l00089"></a>00089         <span class="comment">// on the interpreter to this and other ports</span>
<a name="l00090"></a>00090         mainThreadState = PyEval_SaveThread();
<a name="l00091"></a>00091     }
<a name="l00092"></a>00092     
<a name="l00093"></a>00093     <span class="comment">// Create a thread state just for us</span>
<a name="l00094"></a>00094     this-&gt;threadState = PyThreadState_New(mainThreadState-&gt;interp);
<a name="l00095"></a>00095     PyEval_RestoreThread(this-&gt;threadState);
<a name="l00096"></a>00096     
<a name="l00097"></a>00097     <span class="comment">// Import our supporting library</span>
<a name="l00098"></a>00098     this-&gt;importAdPythonModule();
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="comment">// Try and make an instance of this</span>
<a name="l00101"></a>00101     <span class="keywordflow">if</span> (this-&gt;makePyInst()) {
<a name="l00102"></a>00102         <span class="comment">// We failed, so our params are unusable</span>
<a name="l00103"></a>00103         asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00104"></a>00104             <span class="stringliteral">&quot;%s:%s: User import failed, param lib unusable\n&quot;</span>,
<a name="l00105"></a>00105             <a class="code" href="adPythonPlugin_8cpp.html#af0e94d13028051cd5339d204bfbb057d">driverName</a>, __func__);
<a name="l00106"></a>00106         this-&gt;pluginState = UGLY;
<a name="l00107"></a>00107         setIntegerParam(<a class="code" href="classadPythonPlugin.html#a96ed619adee5401e9078099ac51e1d0a">adPythonState</a>, this-&gt;pluginState);
<a name="l00108"></a>00108         callParamCallbacks();
<a name="l00109"></a>00109     } <span class="keywordflow">else</span> {
<a name="l00110"></a>00110         <span class="comment">// Update param list from dict, also creating keys</span>
<a name="l00111"></a>00111         this-&gt;updateParamList(1);
<a name="l00112"></a>00112     }
<a name="l00113"></a>00113     
<a name="l00114"></a>00114     <span class="comment">// Release the GIL and finish</span>
<a name="l00115"></a>00115     this-&gt;threadState = PyEval_SaveThread();
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 
<a name="l00126"></a><a class="code" href="classadPythonPlugin.html#ad08dae173b0e12e08959dac2c48129d5">00126</a> <span class="keywordtype">void</span> <a class="code" href="classadPythonPlugin.html#ad08dae173b0e12e08959dac2c48129d5">adPythonPlugin::processCallbacks</a>(NDArray *pArray) {
<a name="l00127"></a>00127     <span class="comment">// First call the base class method</span>
<a name="l00128"></a>00128     <a class="code" href="classadPythonPlugin.html#ad08dae173b0e12e08959dac2c48129d5">NDPluginDriver::processCallbacks</a>(pArray);
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     <span class="comment">// Make sure we are in a good state, otherwise do nothing</span>
<a name="l00131"></a>00131     <span class="keywordflow">if</span> (this-&gt;pluginState != <a class="code" href="adPythonPlugin_8cpp.html#a4adf7c6105c54a1608753548236d1387">GOOD</a>) <span class="keywordflow">return</span>;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="comment">// We have to modify our python dict to match our param list</span>
<a name="l00134"></a>00134     <span class="comment">// Note: to avoid deadlocks we should always take locks in order:</span>
<a name="l00135"></a>00135     <span class="comment">//  dictMutex, then GIL, then this-&gt;lock</span>
<a name="l00136"></a>00136     <span class="comment">// so unlock here to preserve this order</span>
<a name="l00137"></a>00137     this-&gt;unlock();
<a name="l00138"></a>00138     epicsMutexLock(this-&gt;dictMutex);
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     <span class="comment">// Make sure we&#39;re allowed to use the python API</span>
<a name="l00141"></a>00141     PyEval_RestoreThread(this-&gt;threadState);
<a name="l00142"></a>00142     this-&gt;lock(); 
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="comment">// Store the time at the beginning of processing for profiling </span>
<a name="l00145"></a>00145     epicsTimeStamp start, end;
<a name="l00146"></a>00146     epicsTimeGetCurrent(&amp;start);
<a name="l00147"></a>00147        
<a name="l00148"></a>00148     <span class="comment">// Update the attribute dict</span>
<a name="l00149"></a>00149     this-&gt;updateAttrDict(pArray);        
<a name="l00150"></a>00150        
<a name="l00151"></a>00151     <span class="comment">// Wrap the NDArray as a python tuple</span>
<a name="l00152"></a>00152     this-&gt;wrapArray(pArray);
<a name="l00153"></a>00153        
<a name="l00154"></a>00154     <span class="comment">// Unlock for long call</span>
<a name="l00155"></a>00155     this-&gt;unlock();
<a name="l00156"></a>00156     
<a name="l00157"></a>00157     <span class="comment">// Make the function call    </span>
<a name="l00158"></a>00158     PyObject *pValue = PyObject_CallObject(this-&gt;pProcessArray, this-&gt;pProcessArgs);
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="comment">// Lock back up</span>
<a name="l00161"></a>00161     this-&gt;lock();
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <span class="comment">// interpret the return value of the python call</span>
<a name="l00164"></a>00164     this-&gt;interpretReturn(pValue);
<a name="l00165"></a>00165     Py_XDECREF(pValue);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     <span class="comment">// copy everything except the data, e.g. uniqueId and timeStamp, attributes</span>
<a name="l00168"></a>00168     <span class="keywordflow">if</span> (this-&gt;pArrays[0]) this-&gt;pNDArrayPool-&gt;copy(pArray, this-&gt;pArrays[0], 0);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="comment">// update param list, this will callParamCallbacks at the end</span>
<a name="l00171"></a>00171     this-&gt;updateParamList(0);    
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <span class="comment">// update the attribute list</span>
<a name="l00174"></a>00174     this-&gt;updateAttrList();
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <span class="comment">// release GIL and dict Mutex    </span>
<a name="l00177"></a>00177     this-&gt;threadState = PyEval_SaveThread();
<a name="l00178"></a>00178     epicsMutexUnlock(this-&gt;dictMutex);
<a name="l00179"></a>00179     
<a name="l00180"></a>00180     <span class="comment">// timestamp</span>
<a name="l00181"></a>00181     epicsTimeGetCurrent(&amp;end);
<a name="l00182"></a>00182     setDoubleParam(<a class="code" href="classadPythonPlugin.html#a928016136ec8ce67d75c5fcd644579e0">adPythonTime</a>, epicsTimeDiffInSeconds(&amp;end, &amp;start)*1000);
<a name="l00183"></a>00183     callParamCallbacks();    
<a name="l00184"></a>00184     
<a name="l00185"></a>00185     <span class="comment">// Spit out the array</span>
<a name="l00186"></a>00186     <span class="keywordflow">if</span> (this-&gt;pArrays[0]) {
<a name="l00187"></a>00187         this-&gt;unlock();
<a name="l00188"></a>00188         doCallbacksGenericPointer(this-&gt;pArrays[0], NDArrayData, 0);
<a name="l00189"></a>00189         this-&gt;lock();    
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00202"></a><a class="code" href="classadPythonPlugin.html#aa3fd15654184acbc25a8786a7de7b3f7">00202</a> asynStatus <a class="code" href="classadPythonPlugin.html#aa3fd15654184acbc25a8786a7de7b3f7">adPythonPlugin::writeInt32</a>(asynUser *pasynUser, epicsInt32 value) {
<a name="l00203"></a>00203     <span class="keywordtype">int</span> status = asynSuccess;
<a name="l00204"></a>00204     <span class="keywordtype">int</span> param = pasynUser-&gt;reason;
<a name="l00205"></a>00205     <span class="keywordflow">if</span> (param == <a class="code" href="classadPythonPlugin.html#ac46d9e7f76ebfa2599fbc34e0393f69c">adPythonLoad</a> || 
<a name="l00206"></a>00206             (this-&gt;nextParam &amp;&amp; param &gt;= <a class="code" href="classadPythonPlugin.html#aae7e610601360a6ccf47cbe3888fd48e">adPythonUserParams</a>[0])) {
<a name="l00207"></a>00207         <span class="comment">// We have to modify our python dict to match our param list</span>
<a name="l00208"></a>00208         <span class="comment">// Note: to avoid deadlocks we should always take locks in order:</span>
<a name="l00209"></a>00209         <span class="comment">//  dictMutex, then GIL, then this-&gt;lock</span>
<a name="l00210"></a>00210         <span class="comment">// so unlock here to preserve this order</span>
<a name="l00211"></a>00211         this-&gt;unlock();
<a name="l00212"></a>00212         epicsMutexLock(this-&gt;dictMutex);
<a name="l00213"></a>00213         <span class="comment">// Make sure we&#39;re allowed to use the python API</span>
<a name="l00214"></a>00214         PyEval_RestoreThread(this-&gt;threadState);
<a name="l00215"></a>00215         <span class="comment">// Now call the bast class to write the value to the param list</span>
<a name="l00216"></a>00216         this-&gt;lock();        
<a name="l00217"></a>00217         status |= <a class="code" href="classadPythonPlugin.html#aa3fd15654184acbc25a8786a7de7b3f7">NDPluginDriver::writeInt32</a>(pasynUser, value);               
<a name="l00218"></a>00218         <span class="keywordflow">if</span> (param == <a class="code" href="classadPythonPlugin.html#ac46d9e7f76ebfa2599fbc34e0393f69c">adPythonLoad</a>) {
<a name="l00219"></a>00219             <span class="comment">// signal that we have started loading the python instance</span>
<a name="l00220"></a>00220             callParamCallbacks();
<a name="l00221"></a>00221             <span class="comment">// reload our python instance, this does callParamCallbacks for is</span>
<a name="l00222"></a>00222             status |= setIntegerParam(param, 0);
<a name="l00223"></a>00223             status |= this-&gt;makePyInst();
<a name="l00224"></a>00224         } <span class="keywordflow">else</span> {
<a name="l00225"></a>00225             <span class="comment">// our param lib has changed, so update the dict and reprocess</span>
<a name="l00226"></a>00226             status |= this-&gt;updateParamDict();
<a name="l00227"></a>00227         }
<a name="l00228"></a>00228         <span class="comment">// release GIL and dict Mutex</span>
<a name="l00229"></a>00229         this-&gt;threadState = PyEval_SaveThread();
<a name="l00230"></a>00230         epicsMutexUnlock(this-&gt;dictMutex);    
<a name="l00231"></a>00231     } <span class="keywordflow">else</span> {
<a name="l00232"></a>00232         status |= <a class="code" href="classadPythonPlugin.html#aa3fd15654184acbc25a8786a7de7b3f7">NDPluginDriver::writeInt32</a>(pasynUser, value);
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234     <span class="keywordflow">return</span> (asynStatus) status;
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00245"></a><a class="code" href="classadPythonPlugin.html#a9003ac61e9bb35d9a40f6f58f27c4877">00245</a> asynStatus <a class="code" href="classadPythonPlugin.html#a9003ac61e9bb35d9a40f6f58f27c4877">adPythonPlugin::writeFloat64</a>(asynUser *pasynUser, 
<a name="l00246"></a>00246                                         epicsFloat64 value) {
<a name="l00247"></a>00247     <span class="keywordtype">int</span> status = asynSuccess;
<a name="l00248"></a>00248     <span class="keywordtype">int</span> param = pasynUser-&gt;reason;
<a name="l00249"></a>00249     <span class="keywordflow">if</span> (this-&gt;nextParam &amp;&amp; param &gt;= <a class="code" href="classadPythonPlugin.html#aae7e610601360a6ccf47cbe3888fd48e">adPythonUserParams</a>[0]) {
<a name="l00250"></a>00250         <span class="comment">// We have to modify our python dict to match our param list</span>
<a name="l00251"></a>00251         <span class="comment">// Note: to avoid deadlocks we should always take locks in order:</span>
<a name="l00252"></a>00252         <span class="comment">//  dictMutex, then GIL, then this-&gt;lock</span>
<a name="l00253"></a>00253         <span class="comment">// so unlock here to preserve this order</span>
<a name="l00254"></a>00254         this-&gt;unlock();
<a name="l00255"></a>00255         epicsMutexLock(this-&gt;dictMutex);
<a name="l00256"></a>00256         <span class="comment">// Make sure we&#39;re allowed to use the python API</span>
<a name="l00257"></a>00257         PyEval_RestoreThread(this-&gt;threadState);
<a name="l00258"></a>00258         <span class="comment">// Now call the bast class to write the value to the param list</span>
<a name="l00259"></a>00259         this-&gt;lock();        
<a name="l00260"></a>00260         status |= <a class="code" href="classadPythonPlugin.html#a9003ac61e9bb35d9a40f6f58f27c4877">NDPluginDriver::writeFloat64</a>(pasynUser, value);                
<a name="l00261"></a>00261         <span class="comment">// our param lib has changed, so update the dict and reprocess</span>
<a name="l00262"></a>00262         status |= this-&gt;updateParamDict();
<a name="l00263"></a>00263         <span class="comment">// release GIL and dict Mutex</span>
<a name="l00264"></a>00264         this-&gt;threadState = PyEval_SaveThread();
<a name="l00265"></a>00265         epicsMutexUnlock(this-&gt;dictMutex);                        
<a name="l00266"></a>00266     } <span class="keywordflow">else</span> {
<a name="l00267"></a>00267         status = <a class="code" href="classadPythonPlugin.html#a9003ac61e9bb35d9a40f6f58f27c4877">NDPluginDriver::writeFloat64</a>(pasynUser, value);
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269     <span class="keywordflow">return</span> (asynStatus) status;
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00282"></a><a class="code" href="classadPythonPlugin.html#aa9aa169dabe3de2c497c63303bb69a1d">00282</a> asynStatus <a class="code" href="classadPythonPlugin.html#aa9aa169dabe3de2c497c63303bb69a1d">adPythonPlugin::writeOctet</a>(asynUser *pasynUser, <span class="keyword">const</span> <span class="keywordtype">char</span> *value, 
<a name="l00283"></a>00283                                       <span class="keywordtype">size_t</span> maxChars, <span class="keywordtype">size_t</span> *nActual) {
<a name="l00284"></a>00284     <span class="keywordtype">int</span> status = asynSuccess;
<a name="l00285"></a>00285     <span class="keywordtype">int</span> param = pasynUser-&gt;reason;
<a name="l00286"></a>00286     <span class="keywordflow">if</span> (this-&gt;nextParam &amp;&amp; param &gt;= <a class="code" href="classadPythonPlugin.html#aae7e610601360a6ccf47cbe3888fd48e">adPythonUserParams</a>[0]) {
<a name="l00287"></a>00287         <span class="comment">// We have to modify our python dict to match our param list</span>
<a name="l00288"></a>00288         <span class="comment">// Note: to avoid deadlocks we should always take locks in order:</span>
<a name="l00289"></a>00289         <span class="comment">//  dictMutex, then GIL, then this-&gt;lock</span>
<a name="l00290"></a>00290         <span class="comment">// so unlock here to preserve this order</span>
<a name="l00291"></a>00291         this-&gt;unlock();
<a name="l00292"></a>00292         epicsMutexLock(this-&gt;dictMutex);
<a name="l00293"></a>00293         <span class="comment">// Make sure we&#39;re allowed to use the python API</span>
<a name="l00294"></a>00294         PyEval_RestoreThread(this-&gt;threadState);
<a name="l00295"></a>00295         <span class="comment">// Now call the bast class to write the value to the param list</span>
<a name="l00296"></a>00296         this-&gt;lock();        
<a name="l00297"></a>00297         status |= <a class="code" href="classadPythonPlugin.html#aa9aa169dabe3de2c497c63303bb69a1d">NDPluginDriver::writeOctet</a>(pasynUser, value, maxChars, nActual);                
<a name="l00298"></a>00298         <span class="comment">// our param lib has changed, so update the dict and reprocess</span>
<a name="l00299"></a>00299         status |= this-&gt;updateParamDict();
<a name="l00300"></a>00300         <span class="comment">// release GIL and dict Mutex</span>
<a name="l00301"></a>00301         this-&gt;threadState = PyEval_SaveThread();
<a name="l00302"></a>00302         epicsMutexUnlock(this-&gt;dictMutex);       
<a name="l00303"></a>00303     } <span class="keywordflow">else</span> {
<a name="l00304"></a>00304         status |= <a class="code" href="classadPythonPlugin.html#aa9aa169dabe3de2c497c63303bb69a1d">NDPluginDriver::writeOctet</a>(pasynUser, value, maxChars, nActual);
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306     <span class="keywordflow">return</span> (asynStatus) status;
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00314"></a>00314 asynStatus adPythonPlugin::importAdPythonModule() {
<a name="l00315"></a>00315     <span class="comment">// Create the epicsMutex for locking access to our param dict</span>
<a name="l00316"></a>00316     this-&gt;dictMutex = epicsMutexCreate();
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (this-&gt;dictMutex == NULL) <a class="code" href="adPythonPlugin_8cpp.html#adbde97e2eabf9b7ae8fd2224db37bb98">Ugly</a>(<span class="stringliteral">&quot;epicsMutexCreate failure&quot;</span>);
<a name="l00318"></a>00318     
<a name="l00319"></a>00319     <span class="comment">// Import the adPython module</span>
<a name="l00320"></a>00320     PyObject *pAdPython = PyImport_ImportModule(<span class="stringliteral">&quot;adPythonPlugin&quot;</span>);
<a name="l00321"></a>00321     <span class="keywordflow">if</span> (pAdPython == NULL) <a class="code" href="adPythonPlugin_8cpp.html#adbde97e2eabf9b7ae8fd2224db37bb98">Ugly</a>(<span class="stringliteral">&quot;Can&#39;t import adPythonPlugin&quot;</span>);
<a name="l00322"></a>00322     
<a name="l00323"></a>00323     <span class="comment">// Try and init numpy, needs to be done here as adPythonPlugin might have</span>
<a name="l00324"></a>00324     <span class="comment">// to put it on our path</span>
<a name="l00325"></a>00325     _import_array();
<a name="l00326"></a>00326 
<a name="l00327"></a>00327     <span class="comment">// Get the reference for the makePyInst python function</span>
<a name="l00328"></a>00328     this-&gt;pMakePyInst = PyObject_GetAttrString(pAdPython, <span class="stringliteral">&quot;makePyInst&quot;</span>);    
<a name="l00329"></a>00329     Py_DECREF(pAdPython);
<a name="l00330"></a>00330     <span class="keywordflow">if</span> (this-&gt;pMakePyInst == NULL) <a class="code" href="adPythonPlugin_8cpp.html#adbde97e2eabf9b7ae8fd2224db37bb98">Ugly</a>(<span class="stringliteral">&quot;Can&#39;t get makePyInst ref&quot;</span>);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     <span class="keywordflow">return</span> asynSuccess;   
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00340"></a>00340 asynStatus adPythonPlugin::makePyInst() {     
<a name="l00341"></a>00341     <span class="keywordtype">char</span> filename[BIGBUFFER], classname[BIGBUFFER];
<a name="l00342"></a>00342     
<a name="l00343"></a>00343     <span class="comment">// If adPython module has failed to load we can&#39;t do anything</span>
<a name="l00344"></a>00344     <span class="keywordflow">if</span> (this-&gt;pluginState == <a class="code" href="adPythonPlugin_8cpp.html#aa48769014166b468765be8d748b8ecf0">UGLY</a>) 
<a name="l00345"></a>00345         <a class="code" href="adPythonPlugin_8cpp.html#adbde97e2eabf9b7ae8fd2224db37bb98">Ugly</a>(<span class="stringliteral">&quot;Can&#39;t load user python class as initial load already failed&quot;</span>);
<a name="l00346"></a>00346     
<a name="l00347"></a>00347     <span class="comment">// Get the filename from param lib</span>
<a name="l00348"></a>00348     <span class="keywordflow">if</span> (getStringParam(<a class="code" href="classadPythonPlugin.html#ae43d79535fa567212732349928b11cf8">adPythonFilename</a>, <a class="code" href="adPythonPlugin_8h.html#a33643a85fb3825de1515192fae9e1333">BIGBUFFER</a>, filename)) 
<a name="l00349"></a>00349         <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t get filename&quot;</span>);
<a name="l00350"></a>00350     
<a name="l00351"></a>00351     <span class="comment">// Get the classname from param lib</span>
<a name="l00352"></a>00352     <span class="keywordflow">if</span> (getStringParam(<a class="code" href="classadPythonPlugin.html#a90ce926293785741988457132e9b6da0">adPythonClassname</a>, <a class="code" href="adPythonPlugin_8h.html#a33643a85fb3825de1515192fae9e1333">BIGBUFFER</a>, classname))
<a name="l00353"></a>00353         <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t get classname&quot;</span>);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="comment">// Make tuple for makePyInst</span>
<a name="l00356"></a>00356     PyObject *pArgs = Py_BuildValue(<span class="stringliteral">&quot;sss&quot;</span>, this-&gt;portName, filename, classname);
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (pArgs == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t build tuple for makePyInst()&quot;</span>);
<a name="l00358"></a>00358            
<a name="l00359"></a>00359     <span class="comment">// Create instance of this class, freeing the old one if it exists</span>
<a name="l00360"></a>00360     Py_XDECREF(this-&gt;pInstance);
<a name="l00361"></a>00361     this-&gt;pInstance = PyObject_CallObject(this-&gt;pMakePyInst, pArgs);
<a name="l00362"></a>00362     Py_DECREF(pArgs);
<a name="l00363"></a>00363     <span class="keywordflow">if</span> (this-&gt;pInstance == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t make instance of class&quot;</span>);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="comment">// Get the processArray function ref</span>
<a name="l00366"></a>00366     Py_XDECREF(this-&gt;pProcessArray);
<a name="l00367"></a>00367     this-&gt;pProcessArray = PyObject_GetAttrString(this-&gt;pInstance, <span class="stringliteral">&quot;_processArray&quot;</span>);
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (this-&gt;pProcessArray == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t get processArray ref&quot;</span>);
<a name="l00369"></a>00369     
<a name="l00370"></a>00370     <span class="comment">// Get the paramChanged function ref</span>
<a name="l00371"></a>00371     Py_XDECREF(this-&gt;pParamChanged);
<a name="l00372"></a>00372     this-&gt;pParamChanged = PyObject_GetAttrString(this-&gt;pInstance, <span class="stringliteral">&quot;_paramChanged&quot;</span>);
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (this-&gt;pParamChanged == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t get paramChanged ref&quot;</span>);
<a name="l00374"></a>00374     
<a name="l00375"></a>00375     <span class="comment">// Get the param dict ref</span>
<a name="l00376"></a>00376     Py_XDECREF(this-&gt;pParams);
<a name="l00377"></a>00377     this-&gt;pParams = PyObject_GetAttrString(this-&gt;pInstance, <span class="stringliteral">&quot;_params&quot;</span>);
<a name="l00378"></a>00378     <span class="keywordflow">if</span> (this-&gt;pParams == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t get _params ref&quot;</span>);
<a name="l00379"></a>00379     
<a name="l00380"></a>00380     <span class="comment">// Can reset state now</span>
<a name="l00381"></a>00381     this-&gt;pluginState = GOOD;
<a name="l00382"></a>00382     setIntegerParam(<a class="code" href="classadPythonPlugin.html#a96ed619adee5401e9078099ac51e1d0a">adPythonState</a>, this-&gt;pluginState);
<a name="l00383"></a>00383     callParamCallbacks();
<a name="l00384"></a>00384     <span class="keywordflow">return</span> asynSuccess; 
<a name="l00385"></a>00385 }
<a name="l00386"></a>00386 
<a name="l00394"></a>00394 asynStatus adPythonPlugin::wrapArray(NDArray *pArray) {      
<a name="l00395"></a>00395     <span class="comment">// Return if we aren&#39;t good</span>
<a name="l00396"></a>00396     <span class="keywordflow">if</span> (this-&gt;pluginState != <a class="code" href="adPythonPlugin_8cpp.html#a4adf7c6105c54a1608753548236d1387">GOOD</a>) <span class="keywordflow">return</span> asynError;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     <span class="comment">// Return if no array to operate on</span>
<a name="l00399"></a>00399     <span class="keywordflow">if</span> (pArray == NULL) <span class="keywordflow">return</span> asynError;
<a name="l00400"></a>00400         
<a name="l00401"></a>00401     <span class="comment">// Release the last produced array</span>
<a name="l00402"></a>00402     <span class="keywordflow">if</span> (this-&gt;pArrays[0]) {
<a name="l00403"></a>00403         this-&gt;pArrays[0]-&gt;release();    
<a name="l00404"></a>00404         this-&gt;pArrays[0] = NULL;
<a name="l00405"></a>00405     }
<a name="l00406"></a>00406        
<a name="l00407"></a>00407     <span class="comment">// Create a dimension description for numpy, note that we reverse dims</span>
<a name="l00408"></a>00408     npy_intp npy_dims[ND_ARRAY_MAX_DIMS];
<a name="l00409"></a>00409     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;pArray-&gt;ndims; i++) {        
<a name="l00410"></a>00410         npy_dims[i] = pArray-&gt;dims[pArray-&gt;ndims-i-1].size;
<a name="l00411"></a>00411     }
<a name="l00412"></a>00412     
<a name="l00413"></a>00413     <span class="comment">// Lookup the numpy format from the ad dataType of the array</span>
<a name="l00414"></a>00414     <span class="keywordtype">int</span> npy_fmt;
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (lookupNpyFormat(pArray-&gt;dataType, &amp;npy_fmt))
<a name="l00416"></a>00416         <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t lookup numpy format for dataType&quot;</span>);
<a name="l00417"></a>00417         
<a name="l00418"></a>00418     <span class="comment">// Wrap the existing data from the NDArray in a numpy array</span>
<a name="l00419"></a>00419     <span class="comment">// When created, this is writable, but the python layer sets it readonly</span>
<a name="l00420"></a>00420     PyObject* pValue = PyArray_SimpleNewFromData(pArray-&gt;ndims, npy_dims, 
<a name="l00421"></a>00421         npy_fmt, pArray-&gt;pData);   
<a name="l00422"></a>00422     <span class="keywordflow">if</span> (pValue == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Cannot make numpy array&quot;</span>);
<a name="l00423"></a>00423     
<a name="l00424"></a>00424     <span class="comment">// Construct argument list, don&#39;t increment pValue so it is destroyed with</span>
<a name="l00425"></a>00425     <span class="comment">// pProcessArgs</span>
<a name="l00426"></a>00426     Py_XDECREF(this-&gt;pProcessArgs);
<a name="l00427"></a>00427     this-&gt;pProcessArgs = Py_BuildValue(<span class="stringliteral">&quot;(NO)&quot;</span>, pValue, this-&gt;pAttrs);
<a name="l00428"></a>00428     <span class="keywordflow">if</span> (this-&gt;pProcessArgs == NULL) {
<a name="l00429"></a>00429         Py_DECREF(pValue);    
<a name="l00430"></a>00430         <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Cannot build tuple for processArray()&quot;</span>);
<a name="l00431"></a>00431     }
<a name="l00432"></a>00432     <span class="keywordflow">return</span> asynSuccess;
<a name="l00433"></a>00433 }
<a name="l00434"></a>00434 
<a name="l00441"></a>00441 asynStatus adPythonPlugin::interpretReturn(PyObject *pValue) {     
<a name="l00442"></a>00442     <span class="comment">// Return if we aren&#39;t good</span>
<a name="l00443"></a>00443     <span class="keywordflow">if</span> (this-&gt;pluginState != <a class="code" href="adPythonPlugin_8cpp.html#a4adf7c6105c54a1608753548236d1387">GOOD</a>) <span class="keywordflow">return</span> asynError;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     <span class="comment">// Check return value for existance    </span>
<a name="l00446"></a>00446     <span class="keywordflow">if</span> (pValue == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;processArray() call failed&quot;</span>);
<a name="l00447"></a>00447            
<a name="l00448"></a>00448     <span class="comment">// If it wasn&#39;t an array, just return here</span>
<a name="l00449"></a>00449     <span class="keywordflow">if</span> (!PyObject_IsInstance(pValue, (PyObject*) (&amp;PyArray_Type))) {
<a name="l00450"></a>00450         <span class="keywordflow">return</span> asynSuccess;
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452     
<a name="l00453"></a>00453     <span class="comment">// We must have an array, so find the dataType from it</span>
<a name="l00454"></a>00454     PyArrayObject *pArrayOb = (PyArrayObject *) pValue;
<a name="l00455"></a>00455     NDDataType_t ad_fmt;
<a name="l00456"></a>00456     <span class="keywordflow">if</span> (lookupAdFormat(PyArray_TYPE(pArrayOb), &amp;ad_fmt)) 
<a name="l00457"></a>00457         <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t lookup numpy format for dataType&quot;</span>);
<a name="l00458"></a>00458     
<a name="l00459"></a>00459     <span class="comment">// Create a dimension description from numpy array, note the inverse order</span>
<a name="l00460"></a>00460     <span class="keywordtype">size_t</span> ad_dims[ND_ARRAY_MAX_DIMS];
<a name="l00461"></a>00461     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;PyArray_NDIM(pArrayOb); i++) {
<a name="l00462"></a>00462         ad_dims[i] = PyArray_DIMS(pArrayOb)[PyArray_NDIM(pArrayOb)-i-1];
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464     
<a name="l00465"></a>00465     <span class="comment">/* Allocate the array */</span>
<a name="l00466"></a>00466     this-&gt;pArrays[0] = pNDArrayPool-&gt;alloc(PyArray_NDIM(pArrayOb), ad_dims, 
<a name="l00467"></a>00467         ad_fmt, 0, NULL);
<a name="l00468"></a>00468     <span class="keywordflow">if</span> (this-&gt;pArrays[0] == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Error allocating buffer&quot;</span>);
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     <span class="comment">// TODO: could avoid this memcpy if we could pass an existing</span>
<a name="l00471"></a>00471     <span class="comment">// buffer to NDArray *AND* have it call a user free function</span>
<a name="l00472"></a>00472     NDArrayInfo arrayInfo;    
<a name="l00473"></a>00473     this-&gt;pArrays[0]-&gt;getInfo(&amp;arrayInfo);
<a name="l00474"></a>00474     memcpy(this-&gt;pArrays[0]-&gt;pData, PyArray_DATA(pArrayOb), arrayInfo.totalBytes);              
<a name="l00475"></a>00475     <span class="keywordflow">return</span> asynSuccess; 
<a name="l00476"></a>00476 }           
<a name="l00477"></a>00477 
<a name="l00483"></a>00483 <span class="comment">// TODO: we should make a python wrapper to the param list that handles the</span>
<a name="l00484"></a>00484 <span class="comment">// param getting and setting better. The only issue is that user python code is</span>
<a name="l00485"></a>00485 <span class="comment">// currently called without this-&gt;lock(). Probably not an issue to add it in,</span>
<a name="l00486"></a>00486 <span class="comment">// just needs thinking about</span>
<a name="l00487"></a>00487 asynStatus adPythonPlugin::updateParamDict() { 
<a name="l00488"></a>00488     <span class="comment">// Return if we aren&#39;t all good</span>
<a name="l00489"></a>00489     <span class="keywordflow">if</span> (this-&gt;pluginState != <a class="code" href="adPythonPlugin_8cpp.html#a4adf7c6105c54a1608753548236d1387">GOOD</a>) <span class="keywordflow">return</span> asynError;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <span class="comment">// Create param key list</span>
<a name="l00492"></a>00492     PyObject *pKeys = PyDict_Keys(this-&gt;pParams);
<a name="l00493"></a>00493     <span class="keywordflow">if</span> (pKeys == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t get keys of _param dict\n&quot;</span>);
<a name="l00494"></a>00494     
<a name="l00495"></a>00495     <span class="comment">// Create a param of the correct type for each item</span>
<a name="l00496"></a>00496     <span class="keywordflow">for</span> (Py_ssize_t i=0; i&lt;PyList_Size(pKeys); i++) {
<a name="l00497"></a>00497         <span class="keywordtype">int</span> param;
<a name="l00498"></a>00498         PyObject *key = PyList_GetItem(pKeys, i);
<a name="l00499"></a>00499         PyObject *keyStr = PyObject_Str(key);
<a name="l00500"></a>00500         <span class="keywordtype">char</span> *paramStr = PyString_AsString(keyStr);
<a name="l00501"></a>00501         <span class="keywordflow">if</span> (findParam(paramStr, &amp;param)) {
<a name="l00502"></a>00502             asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00503"></a>00503                 <span class="stringliteral">&quot;%s:%s: can&#39;t find param %s\n&quot;</span>,
<a name="l00504"></a>00504                 <a class="code" href="adPythonPlugin_8cpp.html#af0e94d13028051cd5339d204bfbb057d">driverName</a>, __func__, paramStr);    
<a name="l00505"></a>00505             <span class="keywordflow">continue</span>;        
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507         PyObject *pValue = PyDict_GetItem(this-&gt;pParams, key);
<a name="l00508"></a>00508         <span class="keywordflow">if</span> (PyFloat_Check(pValue)) {
<a name="l00509"></a>00509             <span class="comment">// get float param</span>
<a name="l00510"></a>00510             <span class="keywordtype">double</span> value;
<a name="l00511"></a>00511             getDoubleParam(param, &amp;value);
<a name="l00512"></a>00512             PyDict_SetItem(this-&gt;pParams, key, PyFloat_FromDouble(value));
<a name="l00513"></a>00513         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PyInt_Check(pValue)) {
<a name="l00514"></a>00514             <span class="comment">// get int param</span>
<a name="l00515"></a>00515             <span class="keywordtype">int</span> value;
<a name="l00516"></a>00516             getIntegerParam(param, &amp;value);
<a name="l00517"></a>00517             PyDict_SetItem(this-&gt;pParams, key, PyInt_FromLong(value));
<a name="l00518"></a>00518         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PyString_Check(pValue)) {
<a name="l00519"></a>00519             <span class="comment">// get string param</span>
<a name="l00520"></a>00520             <span class="keywordtype">char</span> value[BIGBUFFER];
<a name="l00521"></a>00521             getStringParam(param, <a class="code" href="adPythonPlugin_8h.html#a33643a85fb3825de1515192fae9e1333">BIGBUFFER</a>, value);
<a name="l00522"></a>00522             PyDict_SetItem(this-&gt;pParams, key, PyString_FromString(value));
<a name="l00523"></a>00523         } <span class="keywordflow">else</span> {
<a name="l00524"></a>00524             asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00525"></a>00525                 <span class="stringliteral">&quot;%s:%s: param %s is not an int, float or string\n&quot;</span>,
<a name="l00526"></a>00526                 <a class="code" href="adPythonPlugin_8cpp.html#af0e94d13028051cd5339d204bfbb057d">driverName</a>, __func__, paramStr);            
<a name="l00527"></a>00527         }
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529     Py_DECREF(pKeys);
<a name="l00530"></a>00530 
<a name="l00531"></a>00531     <span class="comment">// call paramChanged method</span>
<a name="l00532"></a>00532     PyObject *pRet = PyObject_CallObject(this-&gt;pParamChanged, NULL);
<a name="l00533"></a>00533     <span class="keywordflow">if</span> (pRet == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Calling paramChanged failed\n&quot;</span>);
<a name="l00534"></a>00534     
<a name="l00535"></a>00535     <span class="comment">// Update any parameters that may have changed in the paramChanged callback to python</span>
<a name="l00536"></a>00536     this-&gt;updateParamList(0);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538     <span class="keywordflow">return</span> asynSuccess;
<a name="l00539"></a>00539 }
<a name="l00540"></a>00540 
<a name="l00548"></a>00548 asynStatus adPythonPlugin::updateParamList(<span class="keywordtype">int</span> atinit) { 
<a name="l00549"></a>00549     <span class="comment">// Return if we aren&#39;t all good</span>
<a name="l00550"></a>00550     <span class="keywordflow">if</span> (this-&gt;pluginState != <a class="code" href="adPythonPlugin_8cpp.html#a4adf7c6105c54a1608753548236d1387">GOOD</a>) <span class="keywordflow">return</span> asynError;
<a name="l00551"></a>00551     
<a name="l00552"></a>00552     <span class="comment">// Create param key list</span>
<a name="l00553"></a>00553     PyObject *pKeys = PyDict_Keys(this-&gt;pParams);
<a name="l00554"></a>00554     <span class="keywordflow">if</span> (pKeys == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t get keys of _param dict\n&quot;</span>);
<a name="l00555"></a>00555     
<a name="l00556"></a>00556     <span class="comment">// Create a param of the correct type for each item</span>
<a name="l00557"></a>00557     <span class="keywordflow">for</span> (Py_ssize_t i=0; i&lt;PyList_Size(pKeys); i++) {
<a name="l00558"></a>00558         <span class="keywordtype">int</span> param;
<a name="l00559"></a>00559         PyObject *key = PyList_GetItem(pKeys, i);
<a name="l00560"></a>00560         PyObject *keyStr = PyObject_Str(key);
<a name="l00561"></a>00561         <span class="keywordtype">char</span> *paramStr = PyString_AsString(keyStr);
<a name="l00562"></a>00562         <span class="comment">// If not at init, then find the param</span>
<a name="l00563"></a>00563         <span class="keywordflow">if</span> (!atinit) {
<a name="l00564"></a>00564             <span class="keywordflow">if</span> (findParam(paramStr, &amp;param)) {
<a name="l00565"></a>00565                 asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00566"></a>00566                     <span class="stringliteral">&quot;%s:%s: can&#39;t find param %s\n&quot;</span>,
<a name="l00567"></a>00567                     <a class="code" href="adPythonPlugin_8cpp.html#af0e94d13028051cd5339d204bfbb057d">driverName</a>, __func__, paramStr);    
<a name="l00568"></a>00568              <span class="keywordflow">continue</span>;        
<a name="l00569"></a>00569             }
<a name="l00570"></a>00570         }
<a name="l00571"></a>00571         PyObject *value = PyDict_GetItem(this-&gt;pParams, key);
<a name="l00572"></a>00572         <span class="keywordflow">if</span> (PyFloat_Check(value)) {
<a name="l00573"></a>00573             <span class="keywordflow">if</span> (atinit) {
<a name="l00574"></a>00574                 createParam(paramStr, asynParamFloat64, &amp;<a class="code" href="classadPythonPlugin.html#aae7e610601360a6ccf47cbe3888fd48e">adPythonUserParams</a>[this-&gt;nextParam]);
<a name="l00575"></a>00575                 param = <a class="code" href="classadPythonPlugin.html#aae7e610601360a6ccf47cbe3888fd48e">adPythonUserParams</a>[this-&gt;nextParam++];
<a name="l00576"></a>00576             }
<a name="l00577"></a>00577             <span class="comment">// set float param</span>
<a name="l00578"></a>00578             setDoubleParam(param, PyFloat_AsDouble(value));
<a name="l00579"></a>00579         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PyInt_Check(value)) {
<a name="l00580"></a>00580             <span class="keywordflow">if</span> (atinit) {
<a name="l00581"></a>00581                 createParam(paramStr, asynParamInt32, &amp;<a class="code" href="classadPythonPlugin.html#aae7e610601360a6ccf47cbe3888fd48e">adPythonUserParams</a>[this-&gt;nextParam]);
<a name="l00582"></a>00582                 param = <a class="code" href="classadPythonPlugin.html#aae7e610601360a6ccf47cbe3888fd48e">adPythonUserParams</a>[this-&gt;nextParam++];
<a name="l00583"></a>00583             }
<a name="l00584"></a>00584             <span class="comment">// set int param</span>
<a name="l00585"></a>00585             setIntegerParam(param, PyInt_AsLong(value));
<a name="l00586"></a>00586         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PyString_Check(value)) {            
<a name="l00587"></a>00587             <span class="keywordflow">if</span> (atinit) {
<a name="l00588"></a>00588                 createParam(paramStr, asynParamOctet, &amp;<a class="code" href="classadPythonPlugin.html#aae7e610601360a6ccf47cbe3888fd48e">adPythonUserParams</a>[this-&gt;nextParam]);
<a name="l00589"></a>00589                 param = <a class="code" href="classadPythonPlugin.html#aae7e610601360a6ccf47cbe3888fd48e">adPythonUserParams</a>[this-&gt;nextParam++];
<a name="l00590"></a>00590             }
<a name="l00591"></a>00591             <span class="comment">// set string param</span>
<a name="l00592"></a>00592             setStringParam(param, PyString_AsString(value));
<a name="l00593"></a>00593         } <span class="keywordflow">else</span> {
<a name="l00594"></a>00594             asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00595"></a>00595                 <span class="stringliteral">&quot;%s:%s: param %s is not an int, float or string\n&quot;</span>,
<a name="l00596"></a>00596                 <a class="code" href="adPythonPlugin_8cpp.html#af0e94d13028051cd5339d204bfbb057d">driverName</a>, __func__, paramStr);            
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598     }
<a name="l00599"></a>00599     Py_DECREF(pKeys);
<a name="l00600"></a>00600     callParamCallbacks();
<a name="l00601"></a>00601     <span class="keywordflow">return</span> asynSuccess;
<a name="l00602"></a>00602 }
<a name="l00603"></a>00603 
<a name="l00611"></a>00611 <span class="comment">// TODO: as with the param dict, it probably makes sense to expose the param</span>
<a name="l00612"></a>00612 <span class="comment">// list directly to python, although it&#39;s less of a performance hit here as</span>
<a name="l00613"></a>00613 <span class="comment">// we don&#39;t often have many attributes compared to params  </span>
<a name="l00614"></a>00614 asynStatus adPythonPlugin::updateAttrDict(NDArray *pArray) {
<a name="l00615"></a>00615     <span class="comment">// Return if we aren&#39;t all good</span>
<a name="l00616"></a>00616     <span class="keywordflow">if</span> (this-&gt;pluginState != <a class="code" href="adPythonPlugin_8cpp.html#a4adf7c6105c54a1608753548236d1387">GOOD</a>) <span class="keywordflow">return</span> asynError;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618     <span class="comment">// Return if no array to operate on</span>
<a name="l00619"></a>00619     <span class="keywordflow">if</span> (pArray == NULL) <span class="keywordflow">return</span> asynError;
<a name="l00620"></a>00620      
<a name="l00621"></a>00621     <span class="comment">// Make a blank dict for the attributes</span>
<a name="l00622"></a>00622     Py_XDECREF(this-&gt;pAttrs);
<a name="l00623"></a>00623     this-&gt;pAttrs = PyDict_New();
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (this-&gt;pAttrs == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Cannot make attribute dict&quot;</span>);     
<a name="l00625"></a>00625      
<a name="l00626"></a>00626     <span class="comment">/* Construct an attribute list. We use a separate attribute list</span>
<a name="l00627"></a>00627 <span class="comment">     * from the one in pArray to avoid the need to copy the array.</span>
<a name="l00628"></a>00628 <span class="comment">     * First clear the list*/</span>
<a name="l00629"></a>00629     this-&gt;pFileAttributes-&gt;clear();
<a name="l00630"></a>00630     
<a name="l00631"></a>00631     <span class="comment">/* Now get the current values of the attributes for this plugin */</span>
<a name="l00632"></a>00632     this-&gt;getAttributes(this-&gt;pFileAttributes);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="comment">/* Now append the attributes from the array which are already up to date from</span>
<a name="l00635"></a>00635 <span class="comment">     * the driver and prior plugins */</span>
<a name="l00636"></a>00636     pArray-&gt;pAttributeList-&gt;copy(this-&gt;pFileAttributes);    
<a name="l00637"></a>00637            
<a name="l00638"></a>00638     <span class="comment">// Fill it in</span>
<a name="l00639"></a>00639     NDAttribute *pAttr = this-&gt;pFileAttributes-&gt;next(NULL);
<a name="l00640"></a>00640     <span class="keywordflow">while</span>(pAttr != NULL) {    
<a name="l00641"></a>00641         NDAttrDataType_t attrDataType;
<a name="l00642"></a>00642         <span class="keywordtype">size_t</span> attrDataSize;        
<a name="l00643"></a>00643         PyObject *pObject = NULL;
<a name="l00644"></a>00644         pAttr-&gt;getValueInfo(&amp;attrDataType, &amp;attrDataSize);
<a name="l00645"></a>00645         <span class="keywordtype">void</span> *value = calloc(1, attrDataSize);
<a name="l00646"></a>00646         pAttr-&gt;getValue(attrDataType, value, attrDataSize);         
<a name="l00647"></a>00647         <span class="comment">/* If the attribute is a string, attrDataSize is the length of the </span>
<a name="l00648"></a>00648 <span class="comment">         * string including the 0 terminator, otherwise it is the size in bytes </span>
<a name="l00649"></a>00649 <span class="comment">         * of the specific data type</span>
<a name="l00650"></a>00650 <span class="comment">         */</span>
<a name="l00651"></a>00651         <span class="keywordflow">switch</span>(attrDataType) {
<a name="l00652"></a>00652             <span class="keywordflow">case</span>(NDAttrInt8):
<a name="l00653"></a>00653             <span class="keywordflow">case</span>(NDAttrUInt8):
<a name="l00654"></a>00654                 pObject = PyInt_FromLong(*((<span class="keywordtype">short</span>*) value));
<a name="l00655"></a>00655                 <span class="keywordflow">break</span>;
<a name="l00656"></a>00656             <span class="keywordflow">case</span>(NDAttrInt16):
<a name="l00657"></a>00657             <span class="keywordflow">case</span>(NDAttrUInt16):
<a name="l00658"></a>00658                 pObject = PyInt_FromLong(*((<span class="keywordtype">int</span>*) value));
<a name="l00659"></a>00659                 <span class="keywordflow">break</span>;
<a name="l00660"></a>00660             <span class="keywordflow">case</span>(NDAttrInt32):
<a name="l00661"></a>00661             <span class="keywordflow">case</span>(NDAttrUInt32):
<a name="l00662"></a>00662                 pObject = PyInt_FromLong(*((<span class="keywordtype">long</span>*) value)); 
<a name="l00663"></a>00663                 <span class="keywordflow">break</span>;
<a name="l00664"></a>00664             <span class="keywordflow">case</span>(NDAttrFloat32):
<a name="l00665"></a>00665                 pObject = PyFloat_FromDouble(*((<span class="keywordtype">float</span>*) value));
<a name="l00666"></a>00666                 <span class="keywordflow">break</span>;
<a name="l00667"></a>00667             <span class="keywordflow">case</span>(NDAttrFloat64):
<a name="l00668"></a>00668                 pObject = PyFloat_FromDouble(*((<span class="keywordtype">double</span>*) value));
<a name="l00669"></a>00669                 <span class="keywordflow">break</span>;
<a name="l00670"></a>00670             <span class="keywordflow">case</span>(NDAttrString):
<a name="l00671"></a>00671                 pObject = PyString_FromString((<span class="keywordtype">char</span> *) value);
<a name="l00672"></a>00672                 <span class="keywordflow">break</span>;
<a name="l00673"></a>00673             <span class="keywordflow">default</span>:
<a name="l00674"></a>00674                 <span class="keywordflow">break</span>;
<a name="l00675"></a>00675         }
<a name="l00676"></a>00676         free(value);
<a name="l00677"></a>00677         <span class="keywordflow">if</span> (pObject == NULL) {
<a name="l00678"></a>00678             asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00679"></a>00679                 <span class="stringliteral">&quot;%s:%s: attribute %s could not be put in attribute dict\n&quot;</span>,
<a name="l00680"></a>00680                 <a class="code" href="adPythonPlugin_8cpp.html#af0e94d13028051cd5339d204bfbb057d">driverName</a>, __func__, pAttr-&gt;pName);            
<a name="l00681"></a>00681         } <span class="keywordflow">else</span> {            
<a name="l00682"></a>00682             PyDict_SetItemString(this-&gt;pAttrs, pAttr-&gt;pName, pObject); 
<a name="l00683"></a>00683             Py_DECREF(pObject); 
<a name="l00684"></a>00684         }
<a name="l00685"></a>00685         pAttr = this-&gt;pFileAttributes-&gt;next(pAttr);
<a name="l00686"></a>00686     }        
<a name="l00687"></a>00687     <span class="keywordflow">return</span> asynSuccess;
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00696"></a>00696 asynStatus adPythonPlugin::updateAttrList() {
<a name="l00697"></a>00697      <span class="comment">// Return if we aren&#39;t all good</span>
<a name="l00698"></a>00698     <span class="keywordflow">if</span> (this-&gt;pluginState != <a class="code" href="adPythonPlugin_8cpp.html#a4adf7c6105c54a1608753548236d1387">GOOD</a>) <span class="keywordflow">return</span> asynError;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="comment">// Ignore and return if we did not get an a new array out</span>
<a name="l00701"></a>00701     <span class="keywordflow">if</span> (this-&gt;pArrays[0] == NULL) <span class="keywordflow">return</span> asynSuccess;
<a name="l00702"></a>00702 
<a name="l00703"></a>00703     <span class="comment">// Return if we don&#39;t have an attribute dict to read from</span>
<a name="l00704"></a>00704     <span class="keywordflow">if</span> (this-&gt;pAttrs == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Attribute dict is null&quot;</span>);
<a name="l00705"></a>00705 
<a name="l00706"></a>00706     <span class="comment">// Create attr key list</span>
<a name="l00707"></a>00707     PyObject *pKeys = PyDict_Keys(this-&gt;pAttrs);
<a name="l00708"></a>00708     <span class="keywordflow">if</span> (pKeys == NULL) <a class="code" href="adPythonPlugin_8cpp.html#a78eb17b87179b6e12d6e14ffcc6a98ab">Bad</a>(<span class="stringliteral">&quot;Can&#39;t get keys of attribute dict&quot;</span>);
<a name="l00709"></a>00709     
<a name="l00710"></a>00710     <span class="comment">// Create a param of the correct type for each item</span>
<a name="l00711"></a>00711     <span class="keywordflow">for</span> (Py_ssize_t i=0; i&lt;PyList_Size(pKeys); i++) {
<a name="l00712"></a>00712         PyObject *key = PyList_GetItem(pKeys, i);
<a name="l00713"></a>00713         PyObject *keyStr = PyObject_Str(key);
<a name="l00714"></a>00714         <span class="keywordtype">char</span> *paramStr = PyString_AsString(keyStr);
<a name="l00715"></a>00715         PyObject *pValue = PyDict_GetItem(this-&gt;pAttrs, key);
<a name="l00716"></a>00716         <span class="keywordflow">if</span> (PyFloat_Check(pValue)) {
<a name="l00717"></a>00717             <span class="keywordtype">double</span> value = PyFloat_AsDouble(pValue);
<a name="l00718"></a>00718             this-&gt;pArrays[0]-&gt;pAttributeList-&gt;add(paramStr, paramStr, NDAttrFloat64, &amp;value);
<a name="l00719"></a>00719         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PyInt_Check(pValue)) {
<a name="l00720"></a>00720             <span class="keywordtype">long</span> value = PyInt_AsLong(pValue);
<a name="l00721"></a>00721             this-&gt;pArrays[0]-&gt;pAttributeList-&gt;add(paramStr, paramStr, NDAttrInt32, &amp;value);
<a name="l00722"></a>00722         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PyString_Check(pValue)) {     
<a name="l00723"></a>00723             <span class="keywordtype">char</span> *value = PyString_AsString(pValue);
<a name="l00724"></a>00724             this-&gt;pArrays[0]-&gt;pAttributeList-&gt;add(paramStr, paramStr, NDAttrString, value);
<a name="l00725"></a>00725         } <span class="keywordflow">else</span> {
<a name="l00726"></a>00726             asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00727"></a>00727                 <span class="stringliteral">&quot;%s:%s: param %s is not an int, float or string\n&quot;</span>,
<a name="l00728"></a>00728                 <a class="code" href="adPythonPlugin_8cpp.html#af0e94d13028051cd5339d204bfbb057d">driverName</a>, __func__, paramStr);            
<a name="l00729"></a>00729         }
<a name="l00730"></a>00730     }
<a name="l00731"></a>00731     Py_DECREF(pKeys);    
<a name="l00732"></a>00732     <span class="keywordflow">return</span> asynSuccess;
<a name="l00733"></a>00733 }
<a name="l00734"></a>00734 
<a name="l00735"></a>00735 <span class="comment">/* The obligatory lookup table of ad datatype to numpy datatype */</span>
<a name="l00736"></a><a class="code" href="structpix__lookup.html">00736</a> <span class="keyword">struct </span><a class="code" href="structpix__lookup.html">pix_lookup</a> {
<a name="l00737"></a><a class="code" href="structpix__lookup.html#ab33e666cb73d558397e1a02e376d5bdf">00737</a>     <span class="keywordtype">int</span> npy_fmt;
<a name="l00738"></a><a class="code" href="structpix__lookup.html#a3b33cbf2130a8eaeaa043693bd10a111">00738</a>     NDDataType_t ad_fmt;
<a name="l00739"></a>00739 };
<a name="l00740"></a>00740 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structpix__lookup.html">pix_lookup</a> <a class="code" href="structpix__lookup.html">pix_lookup</a>[] = {
<a name="l00741"></a>00741    { NPY_INT8,     NDInt8 },     
<a name="l00742"></a>00742    { NPY_UINT8,    NDUInt8 },    
<a name="l00743"></a>00743    { NPY_INT16,    NDInt16 },    
<a name="l00744"></a>00744    { NPY_UINT16,   NDUInt16 },   
<a name="l00745"></a>00745    { NPY_INT32,    NDInt32 },    
<a name="l00746"></a>00746    { NPY_UINT16,   NDUInt32 },   
<a name="l00747"></a>00747    { NPY_FLOAT32,  NDFloat32 },  
<a name="l00748"></a>00748    { NPY_FLOAT64,  NDFloat64 }   
<a name="l00749"></a>00749 };
<a name="l00750"></a>00750 
<a name="l00752"></a>00752 asynStatus adPythonPlugin::lookupNpyFormat(NDDataType_t ad_fmt, <span class="keywordtype">int</span> *npy_fmt) {
<a name="l00753"></a>00753     <span class="keyword">const</span> <span class="keywordtype">int</span> N = <span class="keyword">sizeof</span>(pix_lookup) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pix_lookup);
<a name="l00754"></a>00754     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; N; i ++)
<a name="l00755"></a>00755         <span class="keywordflow">if</span> (ad_fmt == pix_lookup[i].ad_fmt) {
<a name="l00756"></a>00756             *npy_fmt = pix_lookup[i].<a class="code" href="structpix__lookup.html#ab33e666cb73d558397e1a02e376d5bdf">npy_fmt</a>;
<a name="l00757"></a>00757             <span class="keywordflow">return</span> asynSuccess;
<a name="l00758"></a>00758         }
<a name="l00759"></a>00759     <span class="keywordflow">return</span> asynError;
<a name="l00760"></a>00760 }
<a name="l00761"></a>00761 
<a name="l00763"></a>00763 asynStatus adPythonPlugin::lookupAdFormat(<span class="keywordtype">int</span> npy_fmt, NDDataType_t *ad_fmt) {
<a name="l00764"></a>00764     <span class="keyword">const</span> <span class="keywordtype">int</span> N = <span class="keyword">sizeof</span>(pix_lookup) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pix_lookup);
<a name="l00765"></a>00765     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; N; i ++)
<a name="l00766"></a>00766         <span class="keywordflow">if</span> (npy_fmt == pix_lookup[i].npy_fmt) {
<a name="l00767"></a>00767             *ad_fmt = pix_lookup[i].<a class="code" href="structpix__lookup.html#a3b33cbf2130a8eaeaa043693bd10a111">ad_fmt</a>;
<a name="l00768"></a>00768             <span class="keywordflow">return</span> asynSuccess;
<a name="l00769"></a>00769         }
<a name="l00770"></a>00770     <span class="keywordflow">return</span> asynError;
<a name="l00771"></a>00771 }
<a name="l00772"></a>00772 
<a name="l00774"></a>00774 <span class="keyword">static</span> <span class="keywordtype">int</span> adPythonPluginConfigure(<span class="keyword">const</span> <span class="keywordtype">char</span> *portNameArg, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename,
<a name="l00775"></a>00775                    <span class="keyword">const</span> <span class="keywordtype">char</span> *classname, <span class="keywordtype">int</span> queueSize, <span class="keywordtype">int</span> blockingCallbacks,
<a name="l00776"></a>00776                    <span class="keyword">const</span> <span class="keywordtype">char</span> *NDArrayPort, <span class="keywordtype">int</span> NDArrayAddr, <span class="keywordtype">int</span> maxBuffers, <span class="keywordtype">size_t</span> maxMemory,
<a name="l00777"></a>00777                    <span class="keywordtype">int</span> priority, <span class="keywordtype">int</span> stackSize) {
<a name="l00778"></a>00778     <span class="comment">// Stack Size must be a minimum of 2MB</span>
<a name="l00779"></a>00779     <span class="keywordflow">if</span> (stackSize &lt; 2097152) stackSize = 2097152;
<a name="l00780"></a>00780     <span class="keyword">new</span> <a class="code" href="classadPythonPlugin.html">adPythonPlugin</a>(portNameArg, filename,
<a name="l00781"></a>00781                    classname, queueSize, blockingCallbacks,
<a name="l00782"></a>00782                    NDArrayPort, NDArrayAddr, maxBuffers, maxMemory,
<a name="l00783"></a>00783                    priority, stackSize);
<a name="l00784"></a>00784     <span class="keywordflow">return</span>(asynSuccess);
<a name="l00785"></a>00785 }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 <span class="comment">/* EPICS iocsh shell commands */</span>
<a name="l00788"></a>00788 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg0 = { <span class="stringliteral">&quot;portName&quot;</span>,iocshArgString};
<a name="l00789"></a>00789 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg1 = { <span class="stringliteral">&quot;filename&quot;</span>,iocshArgString};
<a name="l00790"></a>00790 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg2 = { <span class="stringliteral">&quot;classname&quot;</span>,iocshArgString};
<a name="l00791"></a>00791 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg3 = { <span class="stringliteral">&quot;frame queue size&quot;</span>,iocshArgInt};
<a name="l00792"></a>00792 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg4 = { <span class="stringliteral">&quot;blocking callbacks&quot;</span>,iocshArgInt};
<a name="l00793"></a>00793 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg5 = { <span class="stringliteral">&quot;NDArrayPort&quot;</span>,iocshArgString};
<a name="l00794"></a>00794 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg6 = { <span class="stringliteral">&quot;NDArrayAddr&quot;</span>,iocshArgInt};
<a name="l00795"></a>00795 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg7 = { <span class="stringliteral">&quot;maxBuffers&quot;</span>,iocshArgInt};
<a name="l00796"></a>00796 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg8 = { <span class="stringliteral">&quot;maxMemory&quot;</span>,iocshArgInt};
<a name="l00797"></a>00797 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg9 = { <span class="stringliteral">&quot;priority&quot;</span>,iocshArgInt};
<a name="l00798"></a>00798 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg initArg10 = { <span class="stringliteral">&quot;stackSize&quot;</span>,iocshArgInt};
<a name="l00799"></a>00799 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg * <span class="keyword">const</span> initArgs[] = {&amp;initArg0,
<a name="l00800"></a>00800                                             &amp;initArg1,
<a name="l00801"></a>00801                                             &amp;initArg2,
<a name="l00802"></a>00802                                             &amp;initArg3,
<a name="l00803"></a>00803                                             &amp;initArg4,
<a name="l00804"></a>00804                                             &amp;initArg5,
<a name="l00805"></a>00805                                             &amp;initArg6,
<a name="l00806"></a>00806                                             &amp;initArg7,
<a name="l00807"></a>00807                                             &amp;initArg8,
<a name="l00808"></a>00808                                             &amp;initArg9,
<a name="l00809"></a>00809                                             &amp;initArg10};
<a name="l00810"></a>00810 <span class="keyword">static</span> <span class="keyword">const</span> iocshFuncDef initFuncDef = {<span class="stringliteral">&quot;adPythonPluginConfigure&quot;</span>,11,initArgs};
<a name="l00811"></a>00811 <span class="keyword">static</span> <span class="keywordtype">void</span> initCallFunc(<span class="keyword">const</span> iocshArgBuf *args)
<a name="l00812"></a>00812 {
<a name="l00813"></a>00813     adPythonPluginConfigure(args[0].sval, args[1].sval, args[2].sval, 
<a name="l00814"></a>00814                        args[3].ival, args[4].ival,
<a name="l00815"></a>00815                        args[5].sval, args[6].ival, args[7].ival,
<a name="l00816"></a>00816                        args[8].ival, args[9].ival, args[10].ival);
<a name="l00817"></a>00817 }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 <span class="comment">//extern &quot;C&quot; void adPythonPluginRegister(void);</span>
<a name="l00820"></a>00820 <span class="keyword">static</span> <span class="keywordtype">void</span> adPythonPluginRegister(<span class="keywordtype">void</span>)
<a name="l00821"></a>00821 {
<a name="l00822"></a>00822     iocshRegister(&amp;initFuncDef,initCallFunc);
<a name="l00823"></a>00823 }
<a name="l00824"></a>00824 
<a name="l00825"></a>00825 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00826"></a>00826 <a class="code" href="adPythonPlugin_8cpp.html#a390681fd7cf58925aae87e825e308f3d">epicsExportRegistrar</a>(adPythonPluginRegister);
<a name="l00827"></a>00827 }
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Thu Mar 20 2014 09:02:08 for adPython by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
