<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>adPython: adPython EPICS Support Module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>adPython EPICS Support Module </h1>  </div>
</div>
<div class="contents">
<h3 class="version">0-2 </h3><h2><a class="anchor" id="intro_sec"></a>
Introduction</h2>
<p>adPython is an <a href="http://cars9.uchicago.edu/software/epics/areaDetector.html">areaDetector</a> plugin which allows user python code to be run on each NDArray object the plugin receives, optionally creating a new NDArray object to pass out.</p>
<h2><a class="anchor" id="inst_sec"></a>
Installation</h2>
<ul>
<li>Modify configure/RELEASE</li>
<li>If you have python and numpy in a standard place then comment out PYTHON_PREFIX, otherwise download and install python and numpy and set that macro to the install prefix you used.</li>
<li>Python must be built shared</li>
<li>Set AREADETECTOR to the path of areaDetector 1-9</li>
<li>Type make</li>
<li>Try the example in the <a class="el" href="index.html#user_sec">User Manual</a></li>
</ul>
<h2><a class="anchor" id="bugs_sec"></a>
Known Bugs</h2>
<p>These are a wish list for better performance rather than bugs...</p>
<ul>
<li>Parameter list is converted to a python dictionary and back again for each new NDArray. This would be much better (and not too difficult to do) as python bindings to the parameter library</li>
<li>Numpy array passed back from python for conversion to NDArray is in the right format, but has to be memcpy'd as NDArray release() can't call a user function</li>
</ul>
<h2><a class="anchor" id="build_sec"></a>
Build Instructions</h2>
<ul>
<li><a class="el" href="build_instructions_example.html">Build Instructions for example</a> IOCs build using these build instructions are available in iocs/</li>
</ul>
<h2><a class="anchor" id="user_sec"></a>
User Manual</h2>
<p>This section will set out how to write adPython plugins. It assumes you have setup the example IOC as setup in <a class="el" href="build_instructions_example.html">Build Instructions for example</a>, with a plugin that loads <a class="el" href="adPythonTemplate_8py.html">adPythonTemplate.py</a>, the corresponding database template and EDM screen.</p>
<h3><a class="anchor" id="template_edm"></a>
Edm Screen</h3>
<p>When you load the edm screen for the adPythonTemplate instance you will have a screen that looks like this: </p>
<div align="center">
<img src="template_edm.png" alt="template_edm.png"/>
<p><strong>adPythonTemplate EDM screen</strong></p></div>
<p> The top section is common to all adPython plugins, and shows the filename of the user python code to load, the classname to import from that file, and a button for reading it. It also shows how long the last array took to pass through the user python code, and if there was an error in any user python code.</p>
<p>The bottom section is specific to this specific adPython plugin script. It displays an interface to all parameters defined by this plugin.</p>
<h3><a class="anchor" id="template_python"></a>
Template for writing adPython scripts</h3>
<p>We will walk through the text from <a class="el" href="adPythonTemplate_8py.html">adPythonTemplate.py</a></p>
 <div class="fragment"><pre class="fragment">from <a class="code" href="classadPythonPlugin.html">adPythonPlugin</a> <span class="keyword">import</span> AdPythonPlugin
<span class="keyword">import</span> logging, numpy

<span class="keywordflow">try</span>:
<span class="preprocessor">    # If we have the opencv library then we can use an add that</span>
<span class="preprocessor"></span><span class="preprocessor">    # saturates the datatype rather than overflowing</span>
<span class="preprocessor"></span>    from cv2 <span class="keyword">import</span> add
except ImportError:
<span class="preprocessor">    # otherwise we will use the numpy array add operation which is </span>
<span class="preprocessor"></span><span class="preprocessor">    # faster but will overflow</span>
<span class="preprocessor">    from numpy import add    </span>
</pre></div></p>
<p>First we import the libraries we will need. AdPythonPlugin is the base class we will inherit from, logging is used so we can turn debug logging on and off. The last section shows two different add functions, one from the <a href="http://opencv.org/">OpenCV</a> image processing library which does saturation arithmetic, and a second which is from the numpy library. Numpy must be present in order to compile adPython, but OpenCV is optional</p>
<p><div class="fragment"><pre class="fragment"><span class="keyword">class </span>Template(AdPythonPlugin):
</pre></div></p>
<p>Here we subclass the AdPythonPlugin base class. This will provide us our logger, as well as the hooks that the C code uses to handle errors.</p>
<p><div class="fragment"><pre class="fragment">    def __init__(<span class="keyword">self</span>):
<span class="preprocessor">        # The default logging level is INFO.</span>
<span class="preprocessor"></span><span class="preprocessor">        # Comment this line to set debug logging off</span>
<span class="preprocessor"></span>        <span class="keyword">self</span>.log.setLevel(logging.DEBUG) 
<span class="preprocessor">        # Make some generic parameters</span>
<span class="preprocessor"></span><span class="preprocessor">        # You can change the Name fields on the EDM screen here</span>
<span class="preprocessor"></span><span class="preprocessor">        # Hide them by making their name -1</span>
<span class="preprocessor"></span>        params = dict(int1 = 1,      int1Name = <span class="stringliteral">&quot;Array offset&quot;</span>,
                      int2 = 2,      int2Name = <span class="stringliteral">&quot;Int 2&quot;</span>,
                      int3 = 3,      int3Name = <span class="stringliteral">&quot;-1&quot;</span>,
                      double1 = 1.0, double1Name = <span class="stringliteral">&quot;Double 1&quot;</span>,
                      double2 = 2.0, double2Name = <span class="stringliteral">&quot;Double 2&quot;</span>,
                      double3 = 3.0, double3Name = <span class="stringliteral">&quot;-1&quot;</span>)
        AdPythonPlugin.__init__(self, params)
</pre></div></p>
<p>In the initialiser we are responsible for initialising our parameter library. The C code will create a parameter with name, type and value of every entry in the param dict passes to the baseclass initialiser, so it is important to make sure all parameters you will use in your python code are declared in this dictionary and have the right type (watch out for floats vs integers).</p>
<p>You may have noticed that on the EDM screen some of the parameters were hidden, this is so you can create some python code based on <a class="el" href="adPythonTemplate_8py.html">adPythonTemplate.py</a> without having to create a new database and screen each time. If you change <code>int1Name</code> then its name label will change on the screen, if you set it to <code>-1</code> then it will disappear.</p>
<p>Once the parameter library has been created you can set and get existing parameters by using the dictionary access notation, e.g. <code>self</code>["int1"] = 5.</p>
<p><div class="fragment"><pre class="fragment">    def paramChanged(<span class="keyword">self</span>):
<span class="preprocessor">        # one of our input parameters has changed</span>
<span class="preprocessor"></span><span class="preprocessor">        # just log it for now, do nothing.</span>
<span class="preprocessor">        self.log.debug(&quot;Parameter has been changed %s&quot;, self)</span>
</pre></div></p>
<p>The function is called whenever the parameter dictionary is changed from EPICS. It allows the class to validate its set of parameters and change any stored state associated with these parameters</p>
<p><div class="fragment"><pre class="fragment">    def processArray(<span class="keyword">self</span>, arr, attr):        
<span class="preprocessor">        # Called when the plugin gets a new array</span>
<span class="preprocessor"></span><span class="preprocessor">        # arr is a numpy array</span>
<span class="preprocessor"></span><span class="preprocessor">        # attr is an attribute dictionary that will be attached to the array</span>
<span class="preprocessor"></span><span class="preprocessor">        # In our example we will take our array and add int1 to it.</span>
<span class="preprocessor"></span>        <span class="keywordflow">try</span>:
            out = add(arr, <span class="keyword">self</span>[<span class="stringliteral">&quot;int1&quot;</span>])           
        except TypeError:
            <span class="preprocessor"># early versions of opencv didn&#39;t let you add a scalar to an array</span>
<span class="preprocessor"></span>            out = add(arr, numpy.zeros(arr.shape, arr.dtype) + <span class="keyword">self</span>[<span class="stringliteral">&quot;int1&quot;</span>])                        
        # Stamp the output array with the sum of the resultant array by writing
        # to the attribute dictionary. Note that we convert from the numpy
        # uint64 type to a python integer as we only handle python integers,
        # doubles and strings in the C code <span class="keywordflow">for</span> now
        attr[<span class="stringliteral">&quot;sum&quot;</span>] = <span class="keywordtype">int</span>(out.sum())
        <span class="keyword">self</span>.log.debug(<span class="stringliteral">&quot;Array processed, sum: %d&quot;</span>, attr[<span class="stringliteral">&quot;sum&quot;</span>])        
<span class="preprocessor">        # return the resultant array.</span>
<span class="preprocessor">        return out</span>
</pre></div></p>
<p>This function is called whenever a new NDArray is passed to the plugin. The numpy array <code>arr</code> is a read only array that points to the block of memory owned by the NDArray. The user code can optionally create and return a numpy array as an output that will be copied into a new NDArray. The dictionary <code>attr</code> is an attribute dictionary that will be attached to the new NDArray if it is created.</p>
<p><div class="fragment"><pre class="fragment"><span class="keywordflow">if</span> __name__==<span class="stringliteral">&quot;__main__&quot;</span>:
    Template().runOffline(
        int1=256,            # This has range 0..255
        int2=(100,200),      # This has range 100..199
        double1=(0,5,0.001), # This has range 0, 0.001, 0.002 ... 4.999
        double2=numpy.logspace(1, 5, 3)) # This is 10^1, 10^3, 10^5
</pre></div></p>
<p>adPython has a test offline mode where a script can be called from the commandline and passed a number of images to cycle through. Running the script with a <code>-h</code> argument gives the following:</p>
<div class="fragment"><pre class="fragment">
Usage: adPythonTemplate.py [files...]
        
This program will test the adPythonPlugin with a set of offline files. 
For each f in files:
- if f is a directory then add any png, jpg or tiff files within it to images
- otherwise add f to images
Display a gui that lets the user interactively change parameters on each image
- hit n for next image
- hit p for previous image
- hit q to quit

Options:
  -h, --help  show this help message and exit
  -r, --rgb   Allow rgb images to be passed straight through without
              converting them to greyscale
</pre></div><p>The keywords passed to the runOffline() function will setup sliders for the integer and float parameters, and show a gui where the user can modify the sliders and use the n and p keys to skip between the images. Each keyword argument can be:</p>
<ul>
<li>the maximum range (non-inclusive)</li>
<li>(minimum, maximum) with step of 1 (non-inclusive)</li>
<li>(minimum, maximum, step) (non-inclusive)</li>
<li>a numpy array of points with any spacing</li>
</ul>
<p>The sliders will be set so that the index of the range can be set. It should be noted that the displayed value will be the INDEX of the array, not the parameter value.</p>
<h3><a class="anchor" id="offline_test"></a>
Offline testing</h3>
<p>Lets try a test of the <a class="el" href="adPythonTemplate_8py.html">adPythonTemplate.py</a> script. First we need to put the adPythonApp/src directory on the PYTHONPATH, then we can just pass the script as an argument for the python interpreter you compiled adPython against (called dls-python at Diamond).</p>
<div class="fragment"><pre class="fragment">PYTHONPATH=adPythonApp/src dls-python ./adPythonApp/scripts/adPythonTemplate.py
</pre></div><p>This will run up a window where we can change parameters.</p>
<div align="center">
<img src="offline_test.png" alt="offline_test.png"/>
<p><strong>adPythonTemplate offline test</strong></p></div>
 <h3><a class="anchor" id="template_user"></a>
Writing your own adPython script</h3>
<p>Once you have understood the adPythonTemplate example you can copy it somewhere and try it out. If you keep the same keys in the parameter dictionary then it will work with the <a class="el" href="adPythonTemplate_8template.html">adPythonTemplate.template</a> database and adPythonTemplate.edl screen. To try it out in the example, just change the Filename PV to the full path to your test script, and the Classname PV to the name of the class you want instantiated.</p>
<h3><a class="anchor" id="new_plugin"></a>
Writing an adPython script with custom parameters</h3>
<ul>
<li>Create a new python file in the adPythonApp/scripts directory caller adPython&lt;name&gt;</li>
<li>Create a &lt;name&gt; class that subclasses AdPythonPlugin</li>
<li>Implement the __init__, paramChanged and processArray functions</li>
<li>Create a database for all parameters you have defined in the initialiser</li>
<li>Create an EDM screen that embeds adPythonPlugin.edl with widgets for all records in the database</li>
<li>(DLS only) Add an entry in the builder ArgInfo classname list</li>
</ul>
<h2><a class="anchor" id="bench"></a>
Benchmarks</h2>
<p>a test with a 10Hz URL driver plugin on a 696x816 mono image produced the following CPU loads doing a 7x7 kernel median blur using the openCV library</p>
<ul>
<li>Python: 41.2%</li>
<li>Native C: 41.2%</li>
</ul>
<p>Each plugin was taking about 26ms to process each image. This rough tests shows that for image processing speeds, the time taken to do the C processing far outweights the time taken to do the python conversions.</p>
<h2><a class="anchor" id="GIL"></a>
The global interpreter lock</h2>
<p>It should be noted that multiple python plugins within the same IOC will share the same global interpreter lock. This is a feature of C python. Python wrappers to computationally expensive functions like those in numpy and OpenCV generally release the GIL before doing the operation, so this is unlikely to be an issue if you have a few plugins, but does mean that adPython will not scale infinitely. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Thu Mar 20 2014 09:02:08 for adPython by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
